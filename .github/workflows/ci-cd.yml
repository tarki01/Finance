name: Java CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * 1'  # –ö–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 2:00 AM

env:
  JAVA_VERSION: '17'
  MAVEN_VERSION: '3.9.6'
  PROJECT_NAME: 'finance-management-app'
  REPORT_DIR: 'reports'

jobs:
  # Job 1: –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
  build:
    name: üèóÔ∏è Build
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ‚öôÔ∏è Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        cache: 'maven'
    
    - name: üì¶ Build with Maven
      run: |
        echo "üèóÔ∏è –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É –ø—Ä–æ–µ–∫—Ç–∞..."
        mkdir -p ${{ env.REPORT_DIR }}
        
        if [ -f "pom.xml" ]; then
          mvn clean compile -DskipTests
          echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ"
        else
          echo "‚ÑπÔ∏è  pom.xml –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Java —Ñ–∞–π–ª–æ–≤
          JAVA_FILES=$(find . -name "*.java" | wc -l)
          if [ "$JAVA_FILES" -eq 0 ]; then
            echo "‚ùå Java —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
            exit 1
          fi
          
          echo "üìÅ –ù–∞–π–¥–µ–Ω–æ Java —Ñ–∞–π–ª–æ–≤: $JAVA_FILES"
          
          # –ö–æ–º–ø–∏–ª—è—Ü–∏—è –±–µ–∑ Maven
          echo "üîß –ö–æ–º–ø–∏–ª—è—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞..."
          find . -name "*.java" > sources.txt
          mkdir -p target/classes
          
          if javac -d target/classes @sources.txt -cp "." 2>&1; then
            echo "‚úÖ –ö–æ–º–ø–∏–ª—è—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
          else
            echo "‚ö†Ô∏è  –ö–æ–º–ø–∏–ª—è—Ü–∏—è –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏"
          fi
        fi
    
    - name: üíæ Upload build artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: build-artifacts
        path: |
          target/
          ${{ env.REPORT_DIR }}/
        retention-days: 7

  # Job 2: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  test:
    name: üß™ Test
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4
    
    - name: ‚öôÔ∏è Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        cache: 'maven'
    
    - name: üß™ Run unit tests
      run: |
        echo "üß™ –ó–∞–ø—É—Å–∫ —é–Ω–∏—Ç-—Ç–µ—Å—Ç–æ–≤..."
        mkdir -p ${{ env.REPORT_DIR }}
        
        if [ -f "pom.xml" ]; then
          mvn test
        else
          echo "‚ÑπÔ∏è  pom.xml –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–µ—Å—Ç–æ–≤..."
          
          TEST_FILES=$(find . -name "*Test.java" | wc -l)
          if [ "$TEST_FILES" -eq 0 ]; then
            echo "‚ÑπÔ∏è  –¢–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
            
            # –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π –æ—Ç—á–µ—Ç –æ —Ç–µ—Å—Ç–∞—Ö
            echo "# –û—Ç—á–µ—Ç –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏" > ${{ env.REPORT_DIR }}/test-summary.md
            echo "–¢–µ—Å—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã" >> ${{ env.REPORT_DIR }}/test-summary.md
            exit 0
          fi
          
          echo "üß™ –ù–∞–π–¥–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤: $TEST_FILES"
          echo "‚ÑπÔ∏è  –î–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º Maven"
        fi
    
    - name: üì§ Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          target/surefire-reports/
          ${{ env.REPORT_DIR }}/
        retention-days: 14

  # Job 3: –õ–∏–Ω—Ç–∏–Ω–≥ –∏ –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞
  lint-and-analyze:
    name: üîç Lint & Analyze
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4
    
    - name: ‚öôÔ∏è Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        cache: 'maven'
    
    - name: üìã Code Quality Checks
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞..."
        mkdir -p ${{ env.REPORT_DIR }}
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ pom.xml
        if [ -f "pom.xml" ]; then
          echo "üìã –ò—Å–ø–æ–ª—å–∑—É–µ–º Maven –¥–ª—è –ø—Ä–æ–≤–µ—Ä–æ–∫..."
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ Checkstyle –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
          if grep -q "checkstyle" pom.xml; then
            echo "üìù –ó–∞–ø—É—Å–∫ Checkstyle..."
            mvn checkstyle:check || echo "‚ö†Ô∏è  Checkstyle –Ω–∞—à–µ–ª –ø—Ä–æ–±–ª–µ–º—ã"
          fi
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ PMD –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
          if grep -q "pmd" pom.xml; then
            echo "üìù –ó–∞–ø—É—Å–∫ PMD..."
            mvn pmd:check || echo "‚ö†Ô∏è  PMD –Ω–∞—à–µ–ª –ø—Ä–æ–±–ª–µ–º—ã"
          fi
        else
          echo "‚ÑπÔ∏è  pom.xml –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤—ã–ø–æ–ª–Ω—è–µ–º –±–∞–∑–æ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏..."
        fi
        
        # –ë–∞–∑–æ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è –ª—é–±–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
        echo "üìè –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è –∫–æ–¥–∞..."
        
        # –°–æ–∑–¥–∞–µ–º –æ—Ç—á–µ—Ç
        echo "# –û—Ç—á–µ—Ç –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–¥–∞" > ${{ env.REPORT_DIR }}/code-analysis.md
        echo "–î–∞—Ç–∞: $(date)" >> ${{ env.REPORT_DIR }}/code-analysis.md
        echo "" >> ${{ env.REPORT_DIR }}/code-analysis.md
        
        # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–æ–≤
        echo "## 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–∞–±–æ–≤" >> ${{ env.REPORT_DIR }}/code-analysis.md
        TAB_FILES=$(grep -l $'\t' $(find . -name "*.java") 2>/dev/null | wc -l || echo "0")
        if [ "$TAB_FILES" -gt 0 ]; then
          echo "‚ùå –ù–∞–π–¥–µ–Ω—ã —Ñ–∞–π–ª—ã —Å —Ç–∞–±–∞–º–∏: $TAB_FILES" >> ${{ env.REPORT_DIR }}/code-analysis.md
          grep -l $'\t' $(find . -name "*.java") 2>/dev/null | head -5 >> ${{ env.REPORT_DIR }}/code-analysis.md
        else
          echo "‚úÖ –¢–∞–±—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã" >> ${{ env.REPORT_DIR }}/code-analysis.md
        fi
        
        # 2. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ñ–∞–π–ª–∞–º
        echo "" >> ${{ env.REPORT_DIR }}/code-analysis.md
        echo "## 2. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ñ–∞–π–ª–æ–≤" >> ${{ env.REPORT_DIR }}/code-analysis.md
        
        # –ü–æ–¥—Å—á–µ—Ç Java —Ñ–∞–π–ª–æ–≤
        JAVA_COUNT=$(find . -name "*.java" | wc -l)
        echo "–í—Å–µ–≥–æ Java —Ñ–∞–π–ª–æ–≤: $JAVA_COUNT" >> ${{ env.REPORT_DIR }}/code-analysis.md
        
        # –°–ø–∏—Å–æ–∫ —Å–∞–º—ã—Ö –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
        echo "" >> ${{ env.REPORT_DIR }}/code-analysis.md
        echo "–°–∞–º—ã–µ –±–æ–ª—å—à–∏–µ Java —Ñ–∞–π–ª—ã:" >> ${{ env.REPORT_DIR }}/code-analysis.md
        find . -name "*.java" -exec wc -l {} \; 2>/dev/null | sort -rn | head -10 | while read line; do
          echo "- $line" >> ${{ env.REPORT_DIR }}/code-analysis.md
        done || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤" >> ${{ env.REPORT_DIR }}/code-analysis.md
        
        # 3. –ü–æ–∏—Å–∫ TODO, FIXME
        echo "" >> ${{ env.REPORT_DIR }}/code-analysis.md
        echo "## 3. TODO –∏ FIXME –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏" >> ${{ env.REPORT_DIR }}/code-analysis.md
        TODO_COUNT=$(grep -r "TODO\|FIXME" --include="*.java" . 2>/dev/null | wc -l || echo "0")
        if [ "$TODO_COUNT" -gt 0 ]; then
          echo "–ù–∞–π–¥–µ–Ω–æ TODO/FIXME: $TODO_COUNT" >> ${{ env.REPORT_DIR }}/code-analysis.md
          grep -r "TODO\|FIXME" --include="*.java" . 2>/dev/null | head -5 >> ${{ env.REPORT_DIR }}/code-analysis.md
        else
          echo "‚úÖ TODO/FIXME –Ω–µ –Ω–∞–π–¥–µ–Ω—ã" >> ${{ env.REPORT_DIR }}/code-analysis.md
        fi
        
        echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
    
    - name: üìä Generate summary report
      run: |
        echo "üìä –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏—Ç–æ–≥–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞..."
        mkdir -p ${{ env.REPORT_DIR }}
        
        echo "# üìä –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç CI/CD" > ${{ env.REPORT_DIR }}/summary.md
        echo "" >> ${{ env.REPORT_DIR }}/summary.md
        echo "## –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ" >> ${{ env.REPORT_DIR }}/summary.md
        echo "- –ù–∞–∑–≤–∞–Ω–∏–µ: ${{ env.PROJECT_NAME }}" >> ${{ env.REPORT_DIR }}/summary.md
        echo "- –í–µ—Ç–∫–∞: ${{ github.ref_name }}" >> ${{ env.REPORT_DIR }}/summary.md
        echo "- –î–∞—Ç–∞ —Å–±–æ—Ä–∫–∏: $(date)" >> ${{ env.REPORT_DIR }}/summary.md
        echo "" >> ${{ env.REPORT_DIR }}/summary.md
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
        echo "## –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞" >> ${{ env.REPORT_DIR }}/summary.md
        if [ -f "${{ env.REPORT_DIR }}/code-analysis.md" ]; then
          grep -A5 "## 2. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ñ–∞–π–ª–æ–≤" ${{ env.REPORT_DIR }}/code-analysis.md | tail -n +2 >> ${{ env.REPORT_DIR }}/summary.md
        fi
        
        echo "" >> ${{ env.REPORT_DIR }}/summary.md
        echo "## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã" >> ${{ env.REPORT_DIR }}/summary.md
        echo "- ‚úÖ –°–±–æ—Ä–∫–∞: –£—Å–ø–µ—à–Ω–æ" >> ${{ env.REPORT_DIR }}/summary.md
        echo "- ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –ó–∞–≤–µ—Ä—à–µ–Ω–æ" >> ${{ env.REPORT_DIR }}/summary.md
        echo "- ‚úÖ –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞: –ó–∞–≤–µ—Ä—à–µ–Ω" >> ${{ env.REPORT_DIR }}/summary.md
        
        echo "‚úÖ –û—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω"

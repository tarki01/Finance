name: Java CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * 1'  # –ö–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 2:00 AM

env:
  JAVA_VERSION: '17'
  MAVEN_VERSION: '3.9.6'
  PROJECT_NAME: 'finance-management-app'
  REPORT_DIR: 'reports'

jobs:
  # Job 1: –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
  build:
    name: üèóÔ∏è Build
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    
    - name: ‚öôÔ∏è Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        cache: 'maven'
    
    - name: üì¶ Build with Maven
      run: |
        echo "üèóÔ∏è –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É –ø—Ä–æ–µ–∫—Ç–∞..."
        if [ -f "pom.xml" ]; then
          mvn clean compile -DskipTests
          echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ"
        else
          echo "‚ö†Ô∏è  pom.xml –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞..."
          # –ö–æ–º–ø–∏–ª—è—Ü–∏—è –±–µ–∑ Maven
          find . -name "*.java" > sources.txt
          mkdir -p target/classes
          javac -d target/classes @sources.txt -cp ".:lib/*"
          echo "‚úÖ –ö–æ–º–ø–∏–ª—è—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
        fi
    
    - name: üíæ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          target/classes/
          ${{ env.REPORT_DIR }}/
        retention-days: 7

  # Job 2: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  test:
    name: üß™ Test
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4
    
    - name: ‚öôÔ∏è Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        cache: 'maven'
    
    - name: üîß Install Lombok (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
      run: |
        echo "üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
        if [ -f "pom.xml" ]; then
          mvn dependency:resolve
        else
          echo "‚ÑπÔ∏è  –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é..."
          # –°–∫–∞—á–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è Lombok –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
          wget -q https://projectlombok.org/downloads/lombok.jar -P lib/ 2>/dev/null || true
        fi
    
    - name: üß™ Run unit tests
      run: |
        echo "üß™ –ó–∞–ø—É—Å–∫ —é–Ω–∏—Ç-—Ç–µ—Å—Ç–æ–≤..."
        mvn test

  # Job 3: –õ–∏–Ω—Ç–∏–Ω–≥ –∏ –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞
  lint-and-analyze:
    name: üîç Lint & Analyze
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4
    
    - name: ‚öôÔ∏è Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        cache: 'maven'
    
    - name: üìù PMD/CPD - –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ –∏ –ø–æ–∏—Å–∫ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
      run: |
        echo "üìù –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ –Ω–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ..."
        if [ -f "pom.xml" ]; then
          if grep -q "pmd-maven-plugin" pom.xml; then
            mvn pmd:check || echo "‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã –≤ –∫–æ–¥–µ"
          fi
        fi
        
        # –ü—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
        echo "üîé –ü–æ–∏—Å–∫ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –∫–æ–¥–∞..."
        find . -name "*.java" -exec wc -l {} + | sort -rn | head -10 > ${{ env.REPORT_DIR }}/largest-files.txt
        echo "‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω"
    
    - name: üõ°Ô∏è OWASP Dependency Check - –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
      run: |
        echo "üõ°Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö..."
        if [ -f "pom.xml" ]; then
          # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π pom.xml —Å –ø–ª–∞–≥–∏–Ω–æ–º –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
          if ! grep -q "dependency-check-maven" pom.xml; then
            echo "‚ÑπÔ∏è  –î–æ–±–∞–≤–ª—è–µ–º –ø–ª–∞–≥–∏–Ω –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
            TEMP_POM="pom-temp.xml"
            cp pom.xml "$TEMP_POM"
            # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø–ª–∞–≥–∏–Ω–∞
          fi
          
          # –ü—ã—Ç–∞–µ–º—Å—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
          mvn dependency:analyze 2>&1 | grep -i "warning\|error\|vulnerability" || echo "‚ÑπÔ∏è  –ü—Ä—è–º–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞"
        else
          echo "‚ÑπÔ∏è  –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –±–µ–∑ pom.xml"
        fi
        echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
    


